<?php $messageActions = $this->messageActions; ?>
<?php $singleAction = $messageActions->singleactions; ?>
<?php $action = Zend_Controller_Front::getInstance()->getRequest()->getActionName() ?>
<?php echo $this->partial('partials/message.phtml') ?>
<div id="mainContent" class="clearfix">
    <div class="messageTab">
        <div class="shadowSeparator clearfix">
            <div class="shadowSeparatorBox clearfix">
                <div class="messageButtons clearfix">
                    <a href="<?php echo $this->baseUrl() . '/message/send/'?>"><span class="button-2 createMessage">Create New</span></a>
                    <span class="button-2 trash" onclick="massDelete('<?php echo $action ?>', '<?php echo $this->baseUrl()?>')">Move to Trash</span>
                    <span class="button-2 archived" onclick="massArchive('<?php echo $action ?>', '<?php echo $this->baseUrl()?>')">Move to Archived</span>
                </div>
                <div class="userMessages">
                    <?
                    function substrCool($text, $length)
                    {
                        $length = strripos(substr($text, 0, $length), ' ');
                        return substr($text, 0, $length);
                    }

                    ?>
                    <table class="">
                        <tbody>
                        <?php
                        if ($this->messages) {

                            foreach ($this->messages as $message) {
                                $length = strripos(substr($message['text'], 0, 62), ' ');//cutting text if more then 60 chars
                                if(strlen($message['text'])>60){
                                    $text = substr($message['text'], 0, $length) . '...';
                                }else{
                                    $text = $message['text'];
                                }

                                $singleAction->setAttrib('id', 'singleactions_' . $message['id']);
                                $singleAction->setAttrib('onchange', "messageAction(this.id, '{$action}')");
                                $classNew = '';
                                $isNew = '';
                                $originalTime = $message['created_at'];
                                $time = date("H:i", strtotime($originalTime));
                                if ($message['recipient_status'] == 0) {
                                    $isNew = "/new";
                                    $classNew = 'newMessage';
                                }
                                echo '
	                    <tr>
	                        <td style="width:804px"><input type="checkbox" class="messageCheckboxes" value="' . $message['id'] . '">
                                <a href="' . $this->baseUrl() . '/message/view/' . $message['id'] . $isNew . '">
                                    <span class ="' . $classNew . ' messageSender">' . $message['sender_id'] . '</span>
                                    <span class ="' . $classNew . ' messageTheme">' . $message['theme'] . '</span>
                                    <span class = "messageText">' . $text . '</span></a>

                                    <div class = "rightMessageBlock">
                                        <span class = "messageTime">' . $time . '</span>
                                        <a href="' . $this->baseUrl() . '/message/reply/message_id/' . $message['id'] . '/current_action/"'. $action .'><span class="messageReply"></span></a>
                                        <a href="' . $this->baseUrl() . '/message/forward/message_id/' . $message['id'] . '/current_action/"'. $action .'><span class="messageForward"></span></a>
                                    </div>

	                    </tr>
	                    ';
                            }

                        }

                        ?>

                        </tbody>
                    </table>
                </div><!-- END userMessages -->
            </div><!-- END shadowSeparatorBox -->
        </div><!-- END shadowSeparator -->
    </div><!-- END messageTab -->
</div><!-- END mainContent -->
<style type="text/css">
    .userMessages .newMessage {
        font-weight: bold;
    }

</style>