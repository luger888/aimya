<div id="dialog-form" title="Booking">
    <?php echo $this->bookingForm;?>
</div>
<input type="button" id="bookLesson" value="book lesson">
<script type='text/javascript'>
    jQuery(document).ready(function () {
        var date = new Date();
        var d = date.getDate();
        var m = date.getMonth();
        var y = date.getFullYear();

        jQuery('#calendar').fullCalendar({
            editable:true,
            disableDragging:true,
            disableResizing:true,
            allDay:false,
            header:{
                left:'title',
                center:' agendaDay, month',
                right:'today,  prev, next'
            },
            dayClick:function (date, allDay, jsEvent, view) {
//                $("#dialog-form").dialog( "open" );
//                $('#started_at').val(date);
                jQuery('#calendar').fullCalendar('changeView', 'agendaDay');
                jQuery('#calendar').fullCalendar('gotoDate', date);

            },
            eventClick:function (event, element) {
                var view = jQuery('#calendar').fullCalendar('getView');
                if (view.name == 'agendaDay') { // if clicked on event while in agendaDay
                    jQuery('#booking').css('display', 'block');
                    jQuery('#sendBooking').remove();
                    $("#dialog-form :input").attr("disabled", true);
                    $("#dialog-form").dialog("open");
                    $('#started_at').val(event.started_at);
                    $('#focus_name').val(event.title);
                    $('#add_info').val(event.add_info);
                    $('#rate').val(event.rate);
                    $('#duration').val(event.duration);
                    if(event.video == 1)
                    $('#video').prop('checked', 'true');
                    if(event.feedback == 1)
                        $('#feedback').prop('checked', 'true');
                    if(event.notes == 1)
                        $('#notes').prop('checked', 'true');
                    $('#recipiend_id').val(event.recipient_id + "");
                    if (event.recipient_status == '0' && event.user_id == event.recipient_id) {

                        $("#dialog-form").append('<input type = "button" id ="confirmBooking" onclick="confirmBooking()"  value = "confirm" >');
                        $("#dialog-form").append('<input type = "button" id ="rejectBooking" onclick="rejectBooking()"  value = "reject" >');
                        $("#dialog-form").append('<input type = "hidden" id = "booking_id"  value = ' + event.booking_id + ' >');
                        $("#dialog-form").append('<input type = "hidden" id = "sender_id"  value = ' + event.sender_id + ' >');
                    }

                } else {
                    jQuery('#calendar').fullCalendar('changeView', 'agendaDay');
                    jQuery('#calendar').fullCalendar('gotoDate', event.start);
                }

            },

            events:function (start, end, callback) {
                jQuery("body").append('<div class="loadingIcon"></div>');
                $.ajax({
                    cache:false,
                    url:'booking/index',
                    success:function (msg) {
                        jQuery('.loadingIcon').remove();
                        var events = [];

                        for (var c = 0; c < msg.booking.length; c++) {
                            console.log(msg.booking[c].recipient_id);
                            if(msg.booking[c].recipient_status == '1' ){
                                var eventColor = '#7da028';
                            }else{
                                eventColor = '#643FA8';
                            }


                            events.push({
                                title:msg.booking[c].focus_name,
                                start:msg.booking[c].started_at,
                                started_at:msg.booking[c].started_at,
                                recipient_id:msg.booking[c].recipient_id,
                                recipient_status:msg.booking[c].recipient_status,
                                add_info:msg.booking[c].add_info,
                                rate:msg.booking[c].rate,
                                duration:msg.booking[c].duration,
                                video:msg.booking[c].video,
                                feedback:msg.booking[c].feedback,
                                notes:msg.booking[c].notes,
                                sender_id:msg.booking[c].sender_id+ "",
                                booking_id:msg.booking[c].id+ "",
                                user_id:msg.id,
                                allDay:false,

                                color: eventColor

                            });
                        }
                        callback(events);

                    }
                });
            }



        });

//FORM DIALOG JQUERY

        $("#dialog-form").dialog({
            autoOpen:false,
            height:450,
            width:400,
            modal:true,
            resizable:false,
            close: function() {
                $('#confirmBooking').remove();
                $('#rejectBooking').remove();
            }
        });


        $('#started_at').datetimepicker();

        $('#sendBooking').click(function () {
            $.post(

                "/booking/add/0/controller%3D%3Ebooking/1/action%3D%3Eadd", {
                    "recipient_id":$('#recipiend_id').val(),
                    "focus_name":$('#focus_name').val(),
                    "started_at":$('#started_at').val(),
                    "duration":$('#duration').val(),
                    "feedback":$('#feedback:checked').val() || 0,
                    "video":$('#video:checked').val() || 0,
                    "notes":$('#notes:checked').val() || 0,
                    "rate":$('#rate').val(),
                    "add_info":$('#add_info').val()


                },
                function (response) {
                    $('#calendar').fullCalendar('renderEvent',
                        {
                            title:$('#focus_name').val(),
                            start:$('#started_at').val(),
                            end:$('#started_at').val()
                        });
                    $("#dialog-form").dialog("close");

                });

            return false;
        });
        $('#bookLesson').click(function () {
            jQuery('#booking').css('display', 'block');
            $("#dialog-form :input").attr("disabled", false);
            $("#dialog-form form").get(0).reset();
            $("#dialog-form").dialog("open");

        });
    });//END JQUERY

    function confirmBooking() {
        $.post(

            "/booking/approve/0/controller%3D%3Ebooking/1/action%3D%3Eapprove", {
                "booking_id": $('#booking_id').val()
            },
            function (response) {
                $("#dialog-form").dialog("close");
            });
    }
    function rejectBooking() {
        $.post(

            "/booking/reject/0/controller%3D%3Ebooking/1/action%3D%3Ereject", {
                "booking_id":$('#booking_id').val()
            },
            function (response) {
                $("#dialog-form").dialog("close");
            });
    }

</script>

<div id='calendar'></div>

