<style>
    /* FULL CALENDAR JQUERY CSS*/

#booking {
    display: none;
}
.fc-event-cancel{
    float: right;
    margin-right: 2px;
    cursor:pointer;
}
.isTeacher {
    display: none;
}
.isTeacher span{
    margin-right:3px;
}
.isTeacher label{
    padding-right:15px;
}
#teacher-label {
    display: none;
}

.mainCalendar {
    background-color: #f6f3e4;
}

.senderUser {
    font: 600 10px arial;
}

.fc-event-head .fc-event-focusName, .fc-event-head .fc-event-time {
    float: left;
}

.fc-event-rate, .fc-event-content-confirm, .fc-event-content-approve, .fc-event-content-reject {
    float: right;
}

.fc-widget-header, .fc-widget-content {
    border: 1px solid #9EB668;
}

.fc-border-separate thead {
    text-transform: uppercase;
}

.fc-border-separate thead tr th {
    padding: 5px;
    background-color: #f0f9e6;
    font: 12px 'dosissemibold';
    color: #2e3a12;
    -webkit-box-shadow: 0 0 0 1px rgba(255, 255, 255, 1) inset;
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 1) inset;
    -moz-box-shadow: 0 0 0 1px rgba(255, 255, 255, 1) inset;
}

.fc-border-separate tbody td {
    background-color: #FCFFF6;
}

.fc-border-separate tbody td.fc-other-month {
    background-color: white;
}

.fc-header-title h2 {
    font: 18px 'dosissemibold' !important;
    color: #344608 !important;
}

table:not(.fc-agenda-days) .fc-today {
    background-color: #E5F9C8 !important;
}

.fc-border-separate .fc-today .fc-day-number {
    color: #719511;
}

ul li {
    text-decoration: none;
}

#dialog-form .mainBooking {
    padding: 18px 29px 0 18px
}
#dialog-form .mainBooking .button {
    margin-bottom: 15px;
}
.mainBooking .formRow div {
    float: left;
}

.mainBooking .formRow .t-165 {
    width: 268px;
}

.mainBooking .txt {
    padding: 2px 9px 0 48px;
}

.mainBooking #recipiend_id {
    width: 280px;
}

.mainBooking #duration {
    width: 112px;
}

.mainBooking #rate {
    width: 70px;
}
.mainBooking #started_at{
    width:100px;
    margin-right: 35px;
}
.mainBooking #started_at_time{
    width:75px;
    margin-left:15px;
}
.mainBooking  .button {
    font-family: 'dosissemibold' !important;
    font-size: 12px !important;
    float: right;
}

.mainBooking  .formRow .label {
    width: 95px;
    padding-top: 2px;
}

.mainBooking .checkBoxRow div {
    padding-top: 5px;
}

.mainBooking .checkBoxRow .label {
    width: 114px;
}

.mainBooking .formRow {
    padding-bottom: 19px;
}
.mainBooking .error {
    clear: both;
    font-size: 11px;
    color: #9e4444;
    text-decoration: none;
}
.fc-button-prev, .fc-button-next {
    width: 15px !important;
}

.fc-button-today {
    margin: 0 7px !important;
}

.formRow textarea {
    width: 269px;
}

.fc-event {

    height: auto !important;
    font: 10px arial !important;

}

.fc-event-time, .fc-event-focusName, .fc-event-rate, .fc-event-content-description, .fc-event-content-requested, .fc-event-title {

    font: 10px arial !important;
}

.fc-event-head .fc-event-time, .fc-event-focusName, .fc-event-rate {
    padding-right: 10px;
    padding-top: 5px;
    padding-bottom: 5px;
}

.fc-event-content-description {
    padding-top: 10px;
}

.fc-event-head .fc-event-time, .fc-event-content-description, .fc-event-content-requested {
    padding-left: 10px;

}

.fc-corner-left .fc-button-inner, .fc-corner-left .fc-event-inner {
    margin-left: 0 !important;
}

.fc-event-skin {
    color: #474940;
}

.fc-event-inner {

    color: #474940;
    -webkit-box-shadow: 0 0 10px -7px rgba(0, 0, 0, 0.66) inset;
    box-shadow: 0 0 10px -7px rgba(0, 0, 0, 0.66) inset;
    -moz-box-shadow: 0 0 10px -7px rgba(0, 0, 0, 0.66) inset;

    overflow: visible;
}

.fc-event-content-requested {
    float: left;
    padding-top: 4px;
}

.fc-event-head {
    /* background-color: #fedbdb !important;*/
    /*border: 1px solid #c18989 !important;*/
    width: auto !important;

}

.fc-event:hover {
    z-index: 9 !important;
}

.fc-agenda .fc-agenda-axis {
    width: 34px;
    padding: 0 4px;
    vertical-align: middle;
    text-align: center;
    white-space: nowrap;
    font-weight: normal;
}

.fc-event-hori {
    border: none !important;
}

.fc-event-content {
    /*border: 1px solid #c18989 !important;*/
    width: auto !important;
    padding-bottom: 5px;
}

.fc-header .fc-button {
    margin: 0;
    width: 66px;
}
.cancellation{
    margin-left: 15px;
}

</style>
<div class="mainCalendar mainContainer clearfix">
<div id="dialog-form" title="BOOKING DETAILS">
    <div class="mainBooking">
        <form method="post" action="" id="booking">

            <div class="formRow clearfix">
                <div class="label">Select User:</div>
                <div><?php echo $this->bookingForm->recipiend_id;?></div>
            </div>
            <?php
            if ($this->role !== '1') {
                echo
                    '<div class="formRow isTeacher clearfix">
                        <div class="label">Select your role:</div>
                        <div>' . $this->bookingForm->role . '</div>
                    </div>';
            }
            ?>
            <div class="formRow clearfix">
                <div class="label">Select Date:</div>
                <div><?php echo $this->bookingForm->started_at;?></div>
                <span class="floatLeft">Time:</span>
                <div><?php echo $this->bookingForm->started_at_time;?></div>
            </div>
            <div class="formRow clearfix">
                <div class="label">Focus Name:</div>
                <div><?php echo $this->bookingForm->focus_name;?></div>
            </div>
            <div class="formRow clearfix">
                <div class="label">Lesson Time:</div>
                <div><?php echo $this->bookingForm->duration;?></div>
                <div class="txt">Rate:</div>
                <div><?php echo $this->bookingForm->rate;?></div>
            </div>
            <div class="formRow clearfix checkBoxRow">
                <div class="label">Video Recording:</div>
                <div><?php echo $this->bookingForm->video;?></div>
            </div>
            <div class="formRow clearfix checkBoxRow">
                <div class="label">Feedback:</div>
                <div><?php echo $this->bookingForm->feedback;?></div>
            </div>
            <div class="formRow clearfix checkBoxRow">
                <div class="label">Notes Copy:</div>
                <div><?php echo $this->bookingForm->notes;?></div>
            </div>
            <div class="formRow clearfix">
                <div class="label">Info:</div>
                <div><?php echo $this->bookingForm->add_info;?></div>
            </div>
            <div class="buttonRow clearfix">
                <?php echo $this->bookingForm->sendBooking;?>
            </div>
        </form>

    </div>
</div>
<div class = "usersAlert" id="cancel-confirm" title="LESSON CANCELLATION:">
    <p><span class="ui-icon ui-icon-alert" style="float: left; margin: 0 7px 20px 0;"></span>Message will be sent to other party to confirm the Lesson cancellation! Are you sure you want to Cancel?</p>
</div>
<script type='text/javascript'>
jQuery(document).ready(function () {

    $('#recipiend_id').change(function () {
        if ($("#recipiend_id option:selected").hasClass('2') || $("#recipiend_id option:selected").hasClass('3')) {
            $('.isTeacher').css('display', 'block');
        } else {
            $('.isTeacher').css('display', 'none');
        }
    });
    Date.prototype.addHours= function(h){
        this.setHours(this.getHours()+h);
        return this;
    }
    var pathName = $('#current_url').val();
    var date = new Date();
    var d = date.getDate();
    var m = date.getMonth();
    var y = date.getFullYear();

    jQuery('#calendar').fullCalendar({
        editable:true,
        timeFormat:'(h:mm)tt -',
        buttonIcons:{
            day:''
        },
        disableDragging:true,
        disableResizing:true,
        allDay:false,
        allDaySlot:false,
        ignoreTimezone:true,
        header:{
            left:'title',
            center:'month, agendaDay',
            right:'prev,today,next'
        },
        dayClick:function (date, allDay, jsEvent, view) {
            jQuery('#calendar').fullCalendar('changeView', 'agendaDay');
            jQuery('#calendar').fullCalendar('gotoDate', date);

        },
        eventClick:function (event, element) {
            var view = jQuery('#calendar').fullCalendar('getView');
            if (view.name == 'agendaDay') { // if clicked on event while in agendaDay
            } else {
                jQuery('#calendar').fullCalendar('changeView', 'agendaDay');
                jQuery('#calendar').fullCalendar('gotoDate', event.start);
            }

        },

        events:function (start, end, callback) {
            jQuery("body").append('<div class="loadingIcon"></div>');
            $.ajax({
                cache:false,
                url:pathName + '/booking/index',
                success:function (msg) {
                    jQuery('.loadingIcon').remove();
                    var events = [];
                    for (var c = 0; c < msg.booking.length; c++) {
                        if (msg.booking[c].booking_status == '1') {
                            var eventColor = '#effad0';
                            var borderColor = '#7e954c';
                        } else {
                            eventColor = '#ffe8e8';
                            borderColor = '#c18989';
                        }

                        var start = msg.booking[c].started_at;

                        start = start.replace(" ","T");
                        start = new Date(start);
                        var sender_utc = parseFloat(msg.booking[c].creator_tz.replace(':',"."));
                        var recipient_utc = parseFloat(msg.timezone.replace(':',"."));
                        var utc = recipient_utc - sender_utc;

//                        var time_zone = msg.booking[c].timezone - msg.booking[c].creator_tz;
//                        var utc =  msg.booking[c].creator_tz.getTime() + ( msg.booking[c].creator_tz.getTimezoneOffset() * 60000);

                        if (msg.booking[c].recipient_id == msg.user_id) {


                            var unixStamp = Math.round((start).getTime() / 1000);

                            var dateTime = unixStamp+utc*3600;
                        }else{
                            dateTime = msg.booking[c].started_at;
                        }
                        console.log(start);//pre
                        console.log(recipient_utc);//utc
                        console.log(dateTime);//final
                        events.push({
                            title:msg.booking[c].focus_name,
                            start:dateTime,
                            started_at:dateTime,
                            recipient_id:msg.booking[c].recipient_id,
                            booking_status:msg.booking[c].booking_status,
                            add_info:msg.booking[c].add_info,
                            rate:msg.booking[c].rate,
                            duration:msg.booking[c].duration,
                            video:msg.booking[c].video,
                            feedback:msg.booking[c].feedback,
                            notes:msg.booking[c].notes,
                            is_cancel:msg.booking[c].is_cancel,
                            sender_id:msg.booking[c].sender_id + "",
                            booking_id:msg.booking[c].id + "",
                            timezone_recipient:msg.timezone,
                            timezone_sender:msg.booking[c].creator_tz,
                            user_id:msg.user_id,
                            allDay:false,
                            color:eventColor,
                            backgroundColor:eventColor,
                            borderColor:borderColor

                        });
                    }
                    callback(events);

                }
            });
        },

        eventRender:function (event, element) {
            var view = jQuery('#calendar').fullCalendar('getView');
            if (view.name == 'agendaDay') { // render event in agendaDay

                if (event.duration == '0') {
                    var duration = 'lesson';
                } else {
                    duration = event.duration + ' min';
                }
                if (event.sender_id == event.user_id) {
                    var sender = '<span class ="senderUser">You</span>';
                } else {
                    sender = $('#recipiend_id option[value="' + event.sender_id + '"]').text();
                }
                if (event.recipient_id == event.user_id) {
                    var recipient = '<span class ="senderUser">You</span>';
                } else {
                    recipient = $('#recipiend_id option[value="' + event.recipient_id + '"]').text();
                }
                if(event.booking_status == '1'){
                    var colorAlt = 'green';
                }
                if(event.booking_status == '0'){
                     colorAlt = 'rose';
                }
                if(event.video == '1'){
                    videoActivity = 'active';
                }else{
                    videoActivity ='passive'
                }
                if(event.notes == '1'){
                    notesActivity = 'active';
                }else{
                    notesActivity ='passive'
                }
                if(event.feedback == '1'){
                    feedbackActivity = 'active';
                }else{
                    feedbackActivity ='passive'
                }
                element.find(".fc-event-head").append('<div class ="fc-event-focusName">Focus name: "' + event.title + '"</div>');
                if(event.booking_status == '1' && event.is_cancel =='0'){
                    element.find(".fc-event-head").append('<a class ="fc-event-cancel" onclick ="cancelBooking(this);">X</a>');
                    element.find(".fc-event-head").append('<input type = "hidden" value = '+ event.booking_id +'>');
                    if(event.user_id == event.recipient_id){
                        element.find(".fc-event-head").append('<input type = "hidden" value = '+ event.sender_id +'>');
                    }else{
                        element.find(".fc-event-head").append('<input type = "hidden" value = '+ event.recipient_id +'>');
                    }
                }

                element.find(".fc-event-head").append('<div class = "fc-event-rate">Rate: $' + event.rate + ' / ' + duration + '</div>');
                element.find(".fc-event-content").append('<div class = "fc-event-content-alt floatRight"><span class = "videoRec '+ colorAlt+' '+videoActivity+'"></span> <span class = "feedback '+ colorAlt+' '+feedbackActivity+'"></span><span class = "notes '+ colorAlt+' '+notesActivity+'"></span></div>');
                element.find(".fc-event-content").append('<div class = "fc-event-content-description"> Description: ' + event.add_info + '</div>');
                element.find(".fc-event-content").append('<div class = "fc-event-content-requested">Request from: ' + sender + ' , to:  ' + recipient + '</div>');

                if (event.booking_status == '0' && event.user_id == event.recipient_id) {
                    element.find(".fc-event-content").append('<input type = "button"  id ="rejectBooking" onclick="rejectBooking(this)" value = "Reject"  class="fc-event-content-reject fc-button reject">');
                    element.find(".fc-event-content").append('<input type = "button" id ="confirmBooking" onclick="confirmBooking(this)" value = "Confirm" class = "fc-event-content-confirm fc-button">');
                    element.find(".fc-event-content").append('<input type = "hidden" id = "booking_id"  value = ' + event.booking_id + ' >');
                    element.find(".fc-event-content").append('<input type = "hidden" id = "sender_id"  value = ' + event.sender_id + ' >');
                } else if (event.booking_status == '1') {
                    element.find(".fc-event-content").append('<div class="fc-event-content-approve"><span>Approved</span></div>');
                } else {
                    element.find(".fc-event-content").append('<div class="fc-event-content-approve pending"><span>Pending</span></div>');
                }
                if(event.user_id != event.is_cancel && event.is_cancel != '0'){
                        element.find(".fc-event-content").append('<input type = "button" id ="confirmCancellation" onclick="confirmCancellation(this)" value = "Confirm Cancellation" class = "button cancellation">');
                        element.find(".fc-event-content").append('<input type = "button"  id ="rejectCancellation" onclick="rejectCancellation(this)" value = "Reject Cancellation"  class="button cancellation">');
                        element.find(".fc-event-content").append('<input type = "hidden" id = "booking_id"  value = ' + event.booking_id + ' >');
                }
            }
        }


    });

//FORM DIALOG JQUERY
    $('.fc-header tbody').append('<tr><td><input type="button" id="bookLesson" class = "button-2 book" value="book lesson"><td></tr>');

    $("#dialog-form").dialog({
        autoOpen:false,
        height: 'auto',
        width:450,
        modal:true,
        resizable:false,
        close:function () {

        }
    });
    var oldDateObj = new Date();
    var today = new Date(oldDateObj.getTime() + 10*60000);
    $('#started_at').datepicker({
        minDate: today
    });



    $('#sendBooking').click(function () {
        jQuery("body").append('<div class="loadingIcon"></div>');

        if($('input[name=role]:checked').val() == '2'){
            var role = '0';
        }
        $.post(

            pathName + "/booking/add/0/controller%3D%3Ebooking/1/action%3D%3Eadd", {
                "recipient_id":$('#recipiend_id').val(),
                "focus_name":$('#focus_name').val(),
                "started_at":$('#started_at').val() + ' ' + $('#started_at_time').val(),
                "duration":$('#duration').val(),
                "feedback":$('#feedback:checked').val() || 0,
                "video":$('#video:checked').val() || 0,
                "notes":$('#notes:checked').val() || 0,
                "rate":$('#rate').val(),
                "is_sender_teacher":role || 1,
                "add_info":$('#add_info').val()


            },
            function (response) {

                if(response.success == 1){
                    window.location.reload();
                }else{
                    jQuery('.loadingIcon').remove();
                    $('#booking').find('.error').remove();

                    if($('#recipiend_id').val() == 0){
                        $('#recipiend_id').parent().parent().append('<div class="error">Choose recipient</div>');
                    }
                    $("#recipiend_id").change(function() {
                        $(this).removeClass("input-error");
                        $(this).parent().parent().find('.error').remove();
                    });
                    for (key in response.errors){

                        if(response.errors[key].length>0){
                            $("#" + key).parent().parent().append('<div class="error">' +response.errors[key] + '</div>');
                            $("#" + key).addClass("input-error");
                            $("#" + key).change(function() {
                                $(this).removeClass("input-error");
                                $(this).parent().parent().find('.error').remove();
                            });
                        }

                    }
                }


            });

        return false;
    });
    $('#bookLesson').click(function () {
        $('#booking').find('.error').remove();
        jQuery('#booking').css('display', 'block');

        $("#dialog-form form").get(0).reset();
        $("#dialog-form").dialog("open");
        $('#dialog-form input').prop('checked', false);

    });

//    $('.fc-event-inner').hover(function(){
//        alert(';f')
//        $('.fc-event-cancel').css('display', 'block');
//    },
//        function () {
//            $('.fc-event-cancel').css('display', 'none');
//        });
});//END JQUERY

function confirmBooking(e) {
    pathName = $('#current_url').val();
    $.post(

        pathName + "/booking/approve/0/controller%3D%3Ebooking/1/action%3D%3Eapprove", {
            "booking_id":$(e).nextAll('#booking_id:first').val()
        },
        function (response) {

            if(response.approved){
                $(e).parents('.fc-event-inner').find('.fc-event-head').css('background-color', '#effad0');
                $(e).parents('.fc-event-inner').css('background-color', '#effad0');
                $(e).parents('.fc-event').css('border-color', '#7e954c');
                $(e).parents('.fc-event-inner').css('border-color', '#7e954c');
                $(e).parent().append('<div class="fc-event-content-approve"><span>Approved</span></div>');
                $(e).parents('.fc-event').find('.fc-event-content-reject').remove();
                $(e).parents('.fc-event').find('.fc-event-content-confirm').remove();
            }else{
                alert('You already  approved lesson on this time!')
            }



        });
}
function rejectBooking(e) {
    var pathName = $('#current_url').val();
    $.post(

        pathName + "/booking/reject/0/controller%3D%3Ebooking/1/action%3D%3Ereject", {
            "booking_id":$(e).nextAll('#booking_id:first').val()
        },
        function (response) {
            e.parentNode.parentNode.parentNode.parentNode.removeChild(e.parentNode.parentNode.parentNode);
        });
}

function confirmCancellation(e) {
    var pathName = $('#current_url').val();
    $.post(

        pathName + "/booking/cancel/0/controller%3D%3Ebooking/1/action%3D%3Ecancel", {
            "cancelConfirmId":$(e).nextAll('#booking_id:first').val()
        },
        function (response) {

            if(response.confirmed){
                window.location.reload();
            }



        });
}
function rejectCancellation(e) {
    var pathName = $('#current_url').val();
    $.post(

        pathName + "/booking/cancel/0/controller%3D%3Ebooking/1/action%3D%3Ecancel", {
            "cancelRejectId":$(e).nextAll('#booking_id:first').val()
        },
        function (response) {
            if(response.rejected){
                window.location.reload();
            }
        });
}


function cancelBooking(e) {
    var pathName = $('#current_url').val();
    var id = $(e).nextAll('input[type=hidden]:first').val();
    var recipient_id = $(e).nextAll('input[type=hidden]:last').val();
    $(function() {
        $( "#cancel-confirm" ).dialog({
            resizable: false,
            height:140,
            width:360,
            modal: true,
            buttons: {
                "Yes": function() {
                    $( this ).dialog( "close" );
                    $.ajax({
                        url: pathName + "/booking/cancel",
                        type: "post",
                        data: {
                            'booking_id':id,
                            'recipient_id':recipient_id
                        },
                        success: function(response){
                            //window.location.reload();
                        }
                    });
                },
                No: function() {
                    $( this ).dialog( "close" );
                }
            }
        });
        $('.ui-icon-alert').remove();
    });
}
</script>

<div id='calendar'></div>
</div>
